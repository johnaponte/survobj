<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation trials: non-proportional hazard • survobj</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulation trials: non-proportional hazard">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">survobj</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">3.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/example_distributions.html">Defining and using objects of class SURVIVAL</a></li>
    <li><a class="dropdown-item" href="../articles/simulation_distributions.html">Simulation of survival times</a></li>
    <li><a class="dropdown-item" href="../articles/simulation_recurent.html">Simulating trials with multiple events</a></li>
    <li><a class="dropdown-item" href="../articles/simulation_trials.html">Simulating trials with survival endpoints</a></li>
    <li><a class="dropdown-item" href="../articles/simulation_trials2.html">Simulation trials: non-proportional hazard</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/johnaponte/survobj/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Simulation trials: non-proportional hazard</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/johnaponte/survobj/blob/main/vignettes/simulation_trials2.Rmd" class="external-link"><code>vignettes/simulation_trials2.Rmd</code></a></small>
      <div class="d-none name"><code>simulation_trials2.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>We can use objects of the class SURVIVAL to simulate surviving times
in clinical trials. We present in this example the evaluation of
empirical power to detect non proportionality of the hazard.</p>
<p>In this example, simulation of the survival times in the control
group follows a Weibull distribution with shape 0.8 (negative) and a
failure rate of 0.6 at month 12. The experimental group have a vaccine
efficacy of 80% during the first month, but it decrease linearly to 10%
at month 12. We simulate survival times in the experimental group using
a piecewise exponential distribution with changes each month to follow
the linear decrease of vaccine efficacy.</p>
<p>The empirical power is define as the percentage the test for
non-proportionality p-value is lower or equal than 0.05</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://johnaponte.github.io/survobj/">survobj</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="empirical-power-to-evaluate-non-proportionality-of-the-hazard">Empirical power to evaluate non proportionality of the hazard<a class="anchor" aria-label="anchor" href="#empirical-power-to-evaluate-non-proportionality-of-the-hazard"></a>
</h2>
<p>Assumptions:</p>
<ul>
<li><p>We made 1000 simulations</p></li>
<li><p>There are 250 participants in each group, one group is control
and the other is vaccinated</p></li>
<li><p>The vaccine efficacy is 90% during first month, and it decrease
linearly to 15% at the end of month12</p></li>
<li><p>The control group follows an Weibull distribution with shape 0.8
and a failure rate of 0.4 at month 12.</p></li>
<li><p>The simulated data is analyzed using Cox regression, and the
proportionality of the hazard assumption evaluated following the method
described by <span class="citation">GRAMBSCH and THERNEAU (1994)</span>
and implemented in the <code>survival</code> package with the function
<code><a href="https://rdrr.io/pkg/survival/man/cox.zph.html" class="external-link">cox.zph()</a></code></p></li>
<li><p>We estimate the empirical power as the percentage of the
simulations where the p-value of the coefficient for the group is 0.05
or lower. We present the empirical power and the distribution of the
total number of events and the estimated vaccine efficacy</p></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Number of simulations</span></span>
<span><span class="va">nsim</span> <span class="op">=</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="co"># Participants in each group</span></span>
<span><span class="va">nsubjects</span> <span class="op">=</span> <span class="fl">250</span></span>
<span></span>
<span><span class="co"># Follow-up time</span></span>
<span><span class="va">ftime</span> <span class="op">&lt;-</span> <span class="fl">12</span></span>
<span></span>
<span><span class="co"># Vaccine efficacy</span></span>
<span><span class="va">ve_start</span> <span class="op">=</span> <span class="fl">80</span></span>
<span><span class="va">ve_end</span> <span class="op">=</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Hazard ratio</span></span>
<span><span class="va">hr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">vm</span> <span class="op">&lt;-</span> <span class="va">ve_start</span> <span class="op">-</span> <span class="op">(</span><span class="va">ve_start</span><span class="op">-</span><span class="va">ve_end</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">ftime</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fl">1</span><span class="op">-</span><span class="va">vm</span><span class="op">/</span><span class="fl">100</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Fail events in controls </span></span>
<span><span class="va">fail_control</span> <span class="op">=</span> <span class="fl">0.4</span></span>
<span></span>
<span><span class="co"># Define Object with weibull distribution for events in controls</span></span>
<span><span class="va">s_ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/s_weibull.html">s_weibull</a></span><span class="op">(</span>fail <span class="op">=</span> <span class="va">fail_control</span>, t <span class="op">=</span> <span class="va">ftime</span>, shape <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Define Object with Picewise exponential distribution in vaccinated</span></span>
<span></span>
<span><span class="va">s_vacc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/s_piecewise.html">s_piecewise</a></span><span class="op">(</span></span>
<span>            breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>,<span class="cn">Inf</span><span class="op">)</span>, </span>
<span>            hazards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s_ctrl</span><span class="op">$</span><span class="fu">hfx</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">*</span><span class="fu">hr</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>, <span class="va">s_ctrl</span><span class="op">$</span><span class="fu">hfx</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span><span class="op">*</span><span class="fu">hr</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The following graph compare the two distributions</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/SURVIVAL.html">compare_survival</a></span><span class="op">(</span><span class="va">s_ctrl</span>, <span class="va">s_vacc</span>, timeto <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation_trials2_files/figure-html/simulation2-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="simulation">Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the group for the subjects</span></span>
<span><span class="va">group</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">nsubjects</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">nsubjects</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span></span>
<span><span class="co"># Loop    </span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="va">nsim</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Simulate survival times for event</span></span>
<span>    <span class="co"># Using one distribution for the controls and other for the vaccinated</span></span>
<span>    <span class="va">sim_time_event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s_ctrl</span><span class="op">$</span><span class="fu">rsurv</span><span class="op">(</span><span class="va">nsubjects</span><span class="op">)</span>, <span class="va">s_vacc</span><span class="op">$</span><span class="fu">rsurv</span><span class="op">(</span><span class="va">nsubjects</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Censor events at end of follow-up.</span></span>
<span>    <span class="va">cevent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/censor_event.html">censor_event</a></span><span class="op">(</span>censor_time <span class="op">=</span> <span class="va">ftime</span>, time <span class="op">=</span> <span class="va">sim_time_event</span>, event <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">ctime</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/censor_event.html">censor_time</a></span><span class="op">(</span>censor_time <span class="op">=</span> <span class="va">ftime</span>, time <span class="op">=</span> <span class="va">sim_time_event</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Analyze the data using cox regression</span></span>
<span>    <span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">ctime</span>, <span class="va">cevent</span><span class="op">)</span><span class="op">~</span> <span class="va">group</span><span class="op">)</span></span>
<span>    <span class="va">sreg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span></span>
<span>    <span class="va">phz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html" class="external-link">cox.zph</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Collect the information</span></span>
<span>    <span class="va">pval</span> <span class="op">=</span> <span class="va">phz</span><span class="op">$</span><span class="va">table</span><span class="op">[</span><span class="st">"group"</span>,<span class="st">"p"</span><span class="op">]</span></span>
<span>    <span class="va">ve</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">sreg</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="st">"group"</span>,<span class="st">"coef"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span></span>
<span>    <span class="va">nevents</span> <span class="op">=</span> <span class="va">sreg</span><span class="op">$</span><span class="va">nevent</span></span>
<span>    </span>
<span>    <span class="co"># return values</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>simid <span class="op">=</span> <span class="va">x</span>, <span class="va">pval</span>,<span class="va">ve</span>, <span class="va">nevents</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Join all the simulations in a single data frame</span></span>
<span><span class="va">sim_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">sim</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="analyze-the-simulation">Analyze the simulation<a class="anchor" aria-label="anchor" href="#analyze-the-simulation"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">empirical_power</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html" class="external-link">binom.test</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sim_df</span><span class="op">$</span><span class="va">pval</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sim_df</span><span class="op">$</span><span class="va">pval</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">empirical_power</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="co">#&gt; probability of success </span></span>
<span><span class="co">#&gt;                  0.839</span></span>
<span><span class="va">empirical_power</span><span class="op">$</span><span class="va">conf.int</span></span>
<span><span class="co">#&gt; [1] 0.8147291 0.8612550</span></span>
<span><span class="co">#&gt; attr(,"conf.level")</span></span>
<span><span class="co">#&gt; [1] 0.95</span></span>
<span></span>
<span><span class="co"># Distribution of the simulated VE estimated under PH assumpation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sim_df</span><span class="op">$</span><span class="va">ve</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;   23.74   47.63   52.98   52.32   57.82   72.81</span></span>
<span></span>
<span><span class="co"># Distribution of the simulated number of events</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sim_df</span><span class="op">$</span><span class="va">nevents</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;     126     149     156     156     163     184</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>The simulation provides an estimate of the empirical power to reject
the proportionality of the hazard assumption in this condition as 83.9%
with a 95%CI of ( 81.5%, 86.1% )</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-grambsch1994" class="csl-entry">
GRAMBSCH, PATRICIA M., and TERRY M. THERNEAU. 1994. <span>“Proportional
Hazards Tests and Diagnostics Based on Weighted Residuals.”</span>
<em>Biometrika</em> 81 (3): 515–26. <a href="https://doi.org/10.1093/biomet/81.3.515" class="external-link">https://doi.org/10.1093/biomet/81.3.515</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Aponte John.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
